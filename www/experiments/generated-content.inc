<?php
// OPPORTUNITY: Generated content size and percent

$genContentSize = $testStepResult->getMetric('generated-content-size');
$genContentPercent = $testStepResult->getMetric('generated-content-percent');


if ( isset($genContentSize) && isset($genContentPercent) ) { 
    $genContentSize = intval($genContentSize);
    $genContentPercent = intval($genContentPercent);

    if( $genContentSize > .5 || $genContentPercent > 1 ){

        $amtNote = "(".$genContentPercent."% / ".$genContentSize."kb)";
    
        $assessment["Quick"]["opportunities"][] = array(
            "title" =>  'A significant portion of HTML content ' . $amtNote . ' was generated by JavaScript after delivery.' ,
            "desc" =>  'When critical HTML content is generated with JavaScript in the browser, several performance bottlenecks can arise:',
            "examples" =>  array(
                "Before content can be generated client-side, the browser must first parse, evaluate, and sometimes also request JavaScript over the network. These steps occur after the HTML is initially delivered, and can incur long delays depending on the device.",
                "If the generated HTML contains references to external assets (images for example), the browser will not be able to discover and request them as early as desired."
            ),
            "experiments" =>  array(
                (object) [
                    'title' => 'Compare performance impact of server-delivered HTML',
                    "desc" => '<p>This experiment mimics server-generated HTML by swapping the initial HTML with the fully rendered HTML from this test run. <strong>Note:</strong> this will very likely break site behavior, but is potentially useful for comparing early metrics and assessing whether moving logic to the server is worth the effort.</p>',
                    "expvar" => 'prerender',
                    "expval" => array($id)
                    ]
            ),
            "good" =>  false,
            "hideassets" => true
        );

        $assessment["Usable"]["opportunities"][] = array(
            "title" =>  'A significant portion of HTML content ' . $amtNote . ' was generated by JavaScript after delivery.' ,
            "desc" =>  'When critical HTML content is generated with JavaScript in the browser, it can increase the time it takes for content to be made accessible to assistive technology such as screen readers.',
            "examples" =>  array(),
            "experiments" =>  array(
                (object) [
                    'title' => 'Look for ways to deliver more HTML content from the start',
                    "desc" => '<p>Many modern frameworks offer patterns for generating useful HTML on the server. </p>',
                ]
            ),
            "good" =>  false,
            "hideassets" => true
        );

        $assessment["Resilient"]["opportunities"][] = array(
            "title" =>  'A significant portion of HTML content ' . $amtNote . ' was generated by JavaScript after delivery.' ,
            "desc" =>  '"When critical HTML content is generated with JavaScript in the browser, there is an increased risk of delivering that content successfully. Common issues such as JavaScript errors and third-party network delays and outages can present potential single points of failure."',
            "examples" =>  array(),
            "experiments" =>  array(
                (object) [
                    'title' => 'Test impact on experience if JavaScript fails to execute',
                    "desc" => '<p>This experiment makes all scripts (inline and external) unrecognizable as javascript by the browser in order to demonstrate whether the site will still be usable if JavaScript fails to properly run.</p>',
                    "expvar" => 'swap',
                    "expval" => array(urlencode('<(\/?)script') . '|'.urlencode('<$1scrapt style="display:none"').'|true|gmi')
                ],
                (object) [
                    'title' => 'Test impact on experience if 3rd party JavaScript files hang until timeout.',
                    "desc" => '<p>This experiment will cause external scripts to hang indefinitely, demonstrating the site\'s ability to provide a usable experience in that scenario.</p>',
                    "expvar" => 'swap',
                    "expval" => array('TBD')
                    ]
            ),
            "good" =>  false,
            "hideassets" => true
        );
    }
    else {
        $assessment["Quick"]["opportunities"][] = array( 
            "title" =>  'HTML content was mostly generated server-side.',
            "desc" =>  "When critical HTML content is generated with JavaScript in the browser, several performance bottlenecks can arise.",
            "examples" =>  array(),
            "experiments" =>  array(),
            "good" =>  true
        );

        $assessment["Usable"]["opportunities"][] = array( 
            "title" =>  'HTML content was mostly generated server-side.',
            "desc" =>  "When critical HTML content is generated with JavaScript in the browser, it can increase the time it takes for content to be made accessible to assistive technology such as screen readers.",
            "examples" =>  array(),
            "experiments" =>  array(),
            "good" =>  true
        );

        $assessment["Resilient"]["opportunities"][] = array( 
            "title" =>  'HTML content was mostly generated server-side.',
            "desc" =>  "When critical HTML content is generated with JavaScript in the browser, there is an increased risk of delivering that content successfully. Common issues such as JavaScript errors and third-party network delays and outages can present potential single points of failure.",
            "examples" =>  array(),
            "experiments" =>  array(),
            "good" =>  true
        );
    }
}
?>